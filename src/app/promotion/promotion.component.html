<section class="promo-card">
    <header class="promo-header">
        <h3 class="promo-title">
              <input type="checkbox" class="stack-select" *ngIf="promotion.isStackable" [checked]="isSelected()" (change)="toggleSelect()" [disabled]="isDisabledForStack()" [attr.title]="isDisabledForStack() ? 'Regla: 1 base + múltiples extras compatibles. Primero seleccioná base o una extra inicial.' : 'Seleccionar para combinar'" [attr.aria-label]="'Seleccionar para combinar: '+promotion.title" />
          {{ promotion.title }}
        </h3>
            <button class="icon-btn star" type="button" (click)="toggleFavourite()" [class.active]="isFavourite" [attr.aria-label]="isFavourite ? 'Quitar de favoritos' : 'Marcar como favorito'" title="Favorito">
                <span class="material-symbols-rounded icon" [style.fontVariationSettings]="isFavourite ? '\'FILL\' 1' : '\'FILL\' 0'">grade</span>
            </button>
        <div class="promo-status">
            @if (promotion.activeDate !== null) {
                <span class="badge badge-success" title="Activa">
                    <span class="material-symbols-rounded icon">check_circle</span>
                    Activa hasta {{ promotion.activeDate.to | date:'EEE dd MMM' }}
                </span>
            }
            @else if (promotion.futureDates.length > 0) {
                <span class="badge badge-info" title="Próximamente">
                    <span class="material-symbols-rounded icon">schedule</span>
                    Desde {{ promotion.futureDates[0].from | date:'EEE dd MMM' }}
                </span>
            }
            @else {
                <span class="badge badge-muted" title="Finalizada">
                    <span class="material-symbols-rounded icon">event</span>
                    Última vez: {{ promotion.pastDates[promotion.pastDates.length - 1].to | date:'EEE dd MMM' }}
                </span>
            }
                        <span *ngIf="specificDates().length" class="badge badge-calendar" [attr.title]="(isFutureMonthSpecificDates() ? (specificDatesMonthLabel() + ': ') : 'Fechas específicas: ') + specificDatesFormatted()" [attr.aria-label]="(isFutureMonthSpecificDates() ? (specificDatesMonthLabel() + ': ') : 'Fechas específicas: ') + specificDatesFormatted()">
                                <span class="material-symbols-rounded icon" style="font-size:16px;">event</span>
                                <ng-container *ngIf="isFutureMonthSpecificDates(); else onlyDays">
                                    <span class="month-label">{{ specificDatesMonthLabel() }}</span>
                                    {{ specificDatesDayNumbers() }}
                                </ng-container>
                                <ng-template #onlyDays>{{ specificDatesDayNumbers() }}</ng-template>
                        </span>
        </div>
    </header>

    <div class="promo-meta">
        <div class="meta-item"><span class="meta-label">Descuento</span><span class="meta-value">{{ promotion.discount }}%</span></div>
    <div class="meta-item"><span class="meta-label">Tope</span><span class="meta-value">{{ promotion.limit.amount === 0 ? 'Sin tope' : (promotion.limit.amount | currency:undefined:'symbol':'1.0-0') }}</span></div>
    <div class="meta-item"><span class="meta-label">Importe</span><span class="meta-value">{{ promotion.calculatedPurchaseAmount | currency:undefined:'symbol':'1.0-0' }}</span></div>
    <div class="meta-item" *ngIf="promotion.minAmount"><span class="meta-label">Mínimo</span><span class="meta-value" [attr.title]="'Monto mínimo de compra para aplicar los descuentos'">{{ promotion.minAmount | currency:undefined:'symbol':'1.0-0' }}</span></div>
            <div class="meta-item days" *ngIf="promotion.validity?.days_of_week?.length || (specificDates().length && !isAllWeek())" [attr.aria-label]="activeDaysAriaLabel()">
                <span class="meta-label">Días</span>
                <span class="meta-value week-days">
                    <ng-container *ngIf="isAllWeek(); else partialDays">
                        <span class="day-pill all-days" title="Aplica todos los días">Todos los días</span>
                    </ng-container>
                    <ng-template #partialDays>
                                    <span class="day-pill" *ngFor="let d of weekdaysDisplay()" [class.active]="d.active" [class.specific]="!d.active && d.specific" [attr.title]="d.active ? ('Aplica los ' + d.fullName) : (d.specific ? ('Aplica en fechas puntuales ('+specificDatesFormatted()+') que caen ' + d.fullName) : ('No aplica ' + d.fullName))">{{ d.letter }}</span>
                    </ng-template>
                </span>
            </div>
    </div>

        @if (promotion.payment_methods.length > 0 && promotion.stacking?.type !== 'extra') {
            <div class="payments">
                <h4>Formas de pago</h4>
                <app-per-method-chips
                    [stats]="promotion.activeDate?.perMethod || []"
                    [methods]="promotion.payment_methods"
                    [cap]="promotion.limit?.mode === 'payment_methods' ? promotion.limit.amount : (promotion.limit.totalCap || promotion.limit.amount)"
                    [showSaldo]="true"
                    (addPurchase)="addPurchase(promotion, $event)" />
            </div>
        }
        @else if (promotion.stacking?.type === 'extra') {
            <div class="payments extra-progress" *ngIf="promotion.activeDate !== null">
                <h4>Progreso (extra)</h4>
                <p class="small-hint">La bonificación extra se aplica a cada compra combinada sin distinguir método de pago.</p>
                <div class="single-progress" *ngIf="promotion.activeDate.totalAmountRefunded >= 0">
                    <div class="bar-bg">
                        <div class="bar-fill" [style.width.%]="availableProgress()" aria-hidden="true"></div>
                    </div>
                    <div class="bar-label">Reintegro acumulado: {{ promotion.activeDate.totalAmountRefunded | currency:undefined:'symbol':'1.0-0' }} / {{ (promotion.limit.totalCap || promotion.limit.amount) === 0 ? 'Sin tope' : ((promotion.limit.totalCap || promotion.limit.amount) | currency:undefined:'symbol':'1.0-0') }}</div>
                </div>
            </div>
        }

    @if (promotion.activeDate !== null && promotion.activeDate.totalAmountPurchased > 0) {
        <div class="totals">
            <div><span class="meta-label">Comprado</span><span class="meta-value">{{ promotion.activeDate.totalAmountPurchased | currency:undefined:'symbol':'1.0-0' }}</span></div>
            <div><span class="meta-label">Reintegrado</span><span class="meta-value">{{ promotion.activeDate.totalAmountRefunded | currency:undefined:'symbol':'1.0-0' }}</span></div>
                        <div><span class="meta-label">Disponible</span><span class="meta-value strong" [attr.title]="hasSeparatePerPurchaseCap() ? 'Monto de compra que todavía puede generar reintegros (considerando topes por compra + total)' : 'Monto máximo de compra restante que puede generar reintegro'">{{ promotion.activeDate.availableAmountToPurchase | currency:undefined:'symbol':'1.0-0' }}</span></div>
                        @if (hasSeparatePerPurchaseCap()) {
                            <div><span class="meta-label">Reintegro restante</span><span class="meta-value" [class.strong]="remainingRefundCap()===0" [attr.title]="'Monto de reintegro que queda dentro del tope total'">{{ remainingRefundCap() | currency:undefined:'symbol':'1.0-0' }}</span></div>
                        }
        </div>
                        <!-- Per-method chips already rendered above with add buttons -->
                <ul class="purchase-list minimal">
                    @for (purchase of promotion.activeDate.purchases; track purchase.id) {
                        <li class="purchase-item" [class.stacked]="purchase.promoIds?.length > 1">
                            <div class="purchase-info">
                                <span class="pill">{{ purchase.date | date: 'dd-MM' }}</span>
                                <span class="store">{{ purchase.storeName }}</span>
                                <span class="amount">{{ purchase.amount | currency }}</span>
                                <span class="refund" *ngIf="totalRefund(purchase) > 0" [attr.title]="'Reintegro total de esta compra'">-{{ totalRefund(purchase) | currency }}</span>
                                @if (purchase.promoIds?.length > 1) {
                                    <span class="stack-badge" title="Compra combinada">Combo</span>
                                }
                                <span class="method">/ {{ purchase.paymentMethod }}</span>
                            </div>
                            @if (purchase.breakdown?.length > 0) {
                                <div class="stack-breakdown slim">
                                    <table>
                                        <thead><tr><th>Promo</th><th>Desc</th></tr></thead>
                                        <tbody>
                                            @for (b of purchase.breakdown; track b.promoId) {
                                                <tr>
                                                    <td>{{ findTitle(b.promoId) }}</td>
                                                    <td>{{ b.discountValue | number:'1.0-0' }}</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            <div class="purchase-actions">
                                <button class="icon-btn" type="button" (click)="editPurchase(purchase)" [attr.aria-label]="'Editar compra'" title="Editar compra">
                                    <span class="material-symbols-rounded icon">edit</span>
                                </button>
                                <button class="icon-btn danger" type="button" (click)="removePurchase(purchase)" [attr.aria-label]="'Eliminar compra'" title="Eliminar compra">
                                    <span class="material-symbols-rounded icon">delete</span>
                                </button>
                            </div>
                        </li>
                    }
                </ul>
    }

    @if (promotion.pastDates.length > 0 && (promotion.pastDates[promotion.pastDates.length -1].purchases?.length ?? 0) > 0) {
        <div class="past-toggle">
            <button class="text-btn" type="button" (click)="showPastPurchases=!showPastPurchases">
                <span class="material-symbols-rounded icon chevron" [class.rotate]="showPastPurchases">expand_more</span>
                {{showPastPurchases ? 'Ocultar' : 'Mostrar'}} anteriores
            </button>
        </div>
    }

    @if (showPastPurchases && promotion.pastDates.length > 0 && (promotion.pastDates[promotion.pastDates.length -1].purchases?.length ?? 0) > 0) {
        <div class="past">
            <p class="past-title">Mis pagos periodo anterior
                ({{promotion.pastDates[promotion.pastDates.length -1].from | date: 'dd-MM'}}
                @if ((promotion.pastDates[promotion.pastDates.length -1].from | date) !== (promotion.pastDates[promotion.pastDates.length -1].to | date)) {
                    - {{promotion.pastDates[promotion.pastDates.length -1].to | date: 'dd-MM'}}
                }
                ):
            </p>
                                    <ul class="purchase-list minimal">
                                        @for (purchase of promotion.pastDates[promotion.pastDates.length -1].purchases; track purchase.id) {
                                            <li class="purchase-item" [class.stacked]="purchase.promoIds?.length > 1">
                                                <div class="purchase-info">
                                                    @if ((promotion.pastDates[promotion.pastDates.length -1].from | date) !== (promotion.pastDates[promotion.pastDates.length -1].to | date)) {
                                                        <span class="pill">{{ purchase.date | date: 'dd-MM' }}</span>
                                                    }
                                                    <span class="store">{{ purchase.storeName }}</span>
                                                    <span class="amount">{{ purchase.amount | currency }}</span>
                                                    <span class="method">/ {{ purchase.paymentMethod }}</span>
                                                </div>
                                                @if (purchase.breakdown?.length > 0) {
                                                    <div class="stack-breakdown slim">
                                                        <table>
                                                            <thead><tr><th>Promo</th><th>Desc</th></tr></thead>
                                                            <tbody>
                                                                @for (b of purchase.breakdown; track b.promoId) {
                                                                    <tr>
                                                                        <td>{{ findTitle(b.promoId) }}</td>
                                                                        <td>{{ b.discountValue | number:'1.0-0' }}</td>
                                                                    </tr>
                                                                }
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                }
                                                <div class="purchase-actions">
                                                    <button class="icon-btn" type="button" (click)="editPurchase(purchase)" [attr.aria-label]="'Editar compra'" title="Editar compra">
                                                        <span class="material-symbols-rounded icon">edit</span>
                                                    </button>
                                                    <button class="icon-btn danger" type="button" (click)="removePurchase(purchase)" [attr.aria-label]="'Eliminar compra'" title="Eliminar compra">
                                                        <span class="material-symbols-rounded icon">delete</span>
                                                    </button>
                                                </div>
                                            </li>
                                        }
                                    </ul>
        </div>
    }
</section>